<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Circuitos Eléctricos</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <style>
        /* --- ESTILOS CSS (Sin cambios significativos respecto a la versión anterior) --- */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --component-color: #7f8c8d;
            --current-color: #f39c12;
            --wire-color: #34495e;
            --terminal-color: #95a5a6;
            --terminal-hover-color: var(--primary-color);
            --terminal-connected-color: var(--secondary-color);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f7fa;
        }

        .navbar {
            background-color: var(--dark-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .navbar h1 { font-size: 1.5rem; margin: 0; }
        .navbar-buttons { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:not(:disabled):hover { background-color: #2980b9; }
        .btn-success { background-color: var(--secondary-color); color: white; }
        .btn-success:not(:disabled):hover { background-color: #27ae60; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:not(:disabled):hover { background-color: #c0392b; }
        .btn-sm { padding: 0.2rem 0.5rem; font-size: 0.8rem; }


        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background-color: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-title { padding: 1rem; font-weight: 600; background-color: var(--light-color); border-bottom: 1px solid #ddd; }
        .circuits-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .circuit-item { padding: 0.75rem; margin-bottom: 0.5rem; background-color: #f8f9fa; border-radius: 4px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; position: relative; }
        .circuit-item:hover { background-color: #edf2f7; }
        .circuit-item.active { background-color: #e3f2fd; border-left: 3px solid var(--primary-color); }
        .circuit-item-name { font-weight: 500; margin-bottom: 0.25rem; word-break: break-all; padding-right: 30px; /* Espacio para botón */ }
        .circuit-item-info { font-size: 0.8rem; color: #666; word-break: break-all; }
        .circuit-item .delete-circuit-btn { position: absolute; top: 5px; right: 5px; padding: 2px 5px; font-size: 0.9rem; line-height: 1; height: 20px; width: 20px; text-align: center; }


        .workspace { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .components-toolbar { padding: 0.5rem; background-color: white; border-bottom: 1px solid #ddd; display: flex; gap: 0.5rem; overflow-x: auto; }
        .component-btn { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background-color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; min-width: 60px; transition: all 0.2s; }
        .component-btn:hover { background-color: #f5f7fa; border-color: #ccc; }
        .component-btn:disabled { background-color: #eee; cursor: not-allowed; opacity: 0.6; }
        .component-icon { width: 24px; height: 24px; stroke: var(--component-color); stroke-width: 1.5; fill: none; }
        .component-label { font-size: 0.7rem; text-align: center; }

        .circuit-canvas { flex: 1; background-color: #ffffff; background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px), linear-gradient(to bottom, #e2e8f0 1px, transparent 1px); background-size: 20px 20px; overflow: hidden; position: relative; }
        .circuit-stage { width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow: hidden; z-index: 1; }
        #connections-svg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none; z-index: 0; }
        #connections-svg .connection-wire { stroke: var(--wire-color); stroke-width: 2.5px; stroke-linecap: round; transition: stroke 0.2s ease-in-out; pointer-events: stroke; /* Permitir eventos en el borde */ cursor: pointer; }
        #connections-svg .connection-wire:hover { stroke: var(--primary-color); }
        #connections-svg .connection-wire.active { stroke: var(--current-color); }
        #connections-svg .temp-wire { stroke: var(--primary-color); stroke-width: 2px; stroke-dasharray: 5, 5; }


        .component { position: absolute; background-color: white; border: 1px solid #aaa; border-radius: 4px; padding: 5px; min-width: 60px; display: flex; flex-direction: column; align-items: center; cursor: move; user-select: none; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); z-index: 1; transition: box-shadow 0.2s, border-color 0.2s; }
        .component.selected { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.4); }
        .component.connecting { cursor: crosshair; }
        .component-header { display: flex; justify-content: space-between; width: 100%; margin-bottom: 4px; font-size: 0.7rem; color: #555; }
        .component-name { font-weight: 500; }
        .component-value { font-size: 0.7rem; }
        .component-visual { width: 100%; height: 30px; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; }
        .component-visual svg { width: 32px; height: 32px; stroke: var(--dark-color); stroke-width: 1.5; fill: none; }
        .component[data-type="switch"] .component-visual { cursor: pointer; }

        .component-terminal { position: absolute; width: 12px; height: 12px; background-color: var(--terminal-color); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.2); z-index: 2; cursor: crosshair; transition: background-color 0.2s; }
        .component-terminal:hover, .component-terminal.highlight { background-color: var(--terminal-hover-color); }
        .terminal-left { left: -7px; top: 50%; transform: translateY(-50%); }
        .terminal-right { right: -7px; top: 50%; transform: translateY(-50%); }
        .terminal-top { top: -7px; left: 50%; transform: translateX(-50%); }
        .terminal-bottom { bottom: -7px; left: 50%; transform: translateX(-50%); }


        .control-panel { width: 300px; background-color: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; overflow: hidden; }
        .panel-section { padding: 1rem; border-bottom: 1px solid #ddd; }
        .panel-section:last-child { border-bottom: none; }
        .panel-title { font-weight: 600; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        .panel-title button { padding: 2px 6px; font-size: 0.8rem; }
        .simulation-controls { display: flex; flex-direction: column; gap: 0.75rem; }
        #simulationTime { font-weight: bold; }
        .control-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .control-label { font-size: 0.85rem; color: #666; }
        .slider-container { display: flex; align-items: center; gap: 0.5rem; }
        .slider { flex: 1; }
        .slider-value { font-size: 0.85rem; width: 40px; text-align: right; }
        .component-properties { flex: 1; overflow-y: auto; }
        .no-component-selected { color: #666; font-style: italic; font-size: 0.9rem; padding: 1rem; }
        .property-group { margin-bottom: 0.75rem; }
        .property-item { display: flex; align-items: center; margin-bottom: 0.5rem; gap: 0.5rem; }
        .property-label { width: 80px; font-size: 0.85rem; color: #555; text-align: right; flex-shrink: 0; }
        .property-input { flex: 1; padding: 0.35rem 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem; }
        .property-input:disabled { background-color: #f8f9fa; cursor: not-allowed; }
        .property-unit { font-size: 0.85rem; color: #777; }


        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); width: 90%; max-width: 800px; /* Más ancho para gráficas */ max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { padding: 1rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; }
        .modal-title { font-weight: 600; font-size: 1.25rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .modal-close:hover { color: var(--danger-color); }
        .modal-body { padding: 0; flex: 1; overflow-y: auto; /* Padding se maneja en tabs */ }

        /* Graph Modal specifics */
        .graph-container { width: 100%; height: 350px; /* Más alto */ margin-bottom: 1rem; background-color: #f9f9f9; display:flex; align-items:center; justify-content:center; color:#888; font-style:italic; border: 1px solid #eee; }
         /* Estilos para Recharts (asegúrate que se vean bien) */
         .recharts-wrapper { width: 100% !important; height: 100% !important; }
         .recharts-surface { width: 100%; height: 100%; }
         .recharts-tooltip-wrapper { z-index: 1000; } /* Tooltip encima de todo */

        .formula-container { background-color: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem; font-family: 'Courier New', monospace; overflow-x: auto; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; background-color: #f8f9fa; padding: 0 1rem; }
        .tab { padding: 0.8rem 1.2rem; cursor: pointer; border-bottom: 3px solid transparent; color: #555; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; }
        .tab:hover { background-color: #eee; }
        .tab.active { border-bottom: 3px solid var(--primary-color); color: var(--primary-color); }
        .tab-content { display: none; padding: 1.5rem; /* Padding para el contenido */ }
        .tab-content.active { display: block; }

        /* New Circuit Modal specifics */
        .new-circuit-form { display: flex; flex-direction: column; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .form-label { font-weight: 500; font-size: 0.9rem; }
        .form-input { padding: 0.6rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem; }
        .form-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; }

        /* Tooltip */
        .tooltip { position: absolute; background-color: rgba(0, 0, 0, 0.8); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; z-index: 1000; pointer-events: none; white-space: nowrap; display: none; }

        /* Notification */
        .notification { position: fixed; bottom: 20px; right: 20px; padding: 0.75rem 1rem; background-color: white; border-left: 4px solid var(--primary-color); border-radius: 4px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); z-index: 999; transform: translateX(120%); transition: transform 0.3s ease-out; min-width: 250px; }
        .notification.show { transform: translateX(0); }
        .notification.success { border-left-color: var(--secondary-color); }
        .notification.error { border-left-color: var(--danger-color); }
        .notification.warning { border-left-color: #f39c12; }
        .notification.info { border-left-color: var(--primary-color); }
        .notification-title { font-weight: 600; /* Más grueso */ margin-bottom: 0.25rem; }
        .notification-message { font-size: 0.9rem; /* Más grande */ color: #555; }


        /* Loading Spinner */
        .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid var(--primary-color); width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Component specific styles */
        .led-visual { width: 20px; height: 20px; border-radius: 50%; background-color: #777; border: 2px solid #555; transition: all 0.3s; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
        .led-visual.on { background-color: #f1c40f; border-color: #f39c12; box-shadow: 0 0 12px rgba(241, 196, 15, 0.9), inset 0 0 5px rgba(255,255,255,0.3); }
        .switch-visual { width: 30px; height: 10px; background-color: #ccc; border: 1px solid #999; position: relative; border-radius: 2px; cursor: pointer; }
        .switch-visual::before { content: ''; position: absolute; width: 4px; height: 14px; background-color: #666; top: -3px; left: 4px; transform-origin: bottom center; transform: rotate(-45deg); transition: transform 0.2s ease-in-out, left 0.2s ease-in-out; border-radius: 1px; }
        .switch-visual.on::before { transform: rotate(45deg); left: 22px; }

    </style>
</head>
<body>
    <div class="navbar">
        <h1>Simulador de Circuitos Eléctricos</h1>
        <div class="navbar-buttons">
            <button id="newCircuitBtn" class="btn btn-primary">Nuevo Circuito</button>
            <button id="simulateBtn" class="btn btn-success">Iniciar Simulación</button>
            <button id="generateGraphBtn" class="btn btn-primary">Generar Gráfica</button> </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
             <div class="sidebar-title">Mis Circuitos</div>
             <div id="circuitsList" class="circuits-list"></div>
         </div>

        <div class="workspace">
            <div class="components-toolbar" id="componentsToolbar">
                <button class="component-btn" data-component="resistor" title="Resistencia">
                     <svg class="component-icon" viewBox="0 0 24 24"><path d="M4 12 H 6 L 7 9 L 9 15 L 11 9 L 13 15 L 15 9 L 17 15 L 18 12 H 20"/></svg>
                    <span class="component-label">Resistor</span>
                </button>
                <button class="component-btn" data-component="capacitor" title="Capacitor">
                    <svg class="component-icon" viewBox="0 0 24 24"><path d="M4 12 H 10 M 14 12 H 20 M 10 6 V 18 M 14 6 V 18"/></svg>
                    <span class="component-label">Capacitor</span>
                </button>
                 <button class="component-btn" data-component="inductor" title="Inductor">
                     <svg class="component-icon" viewBox="0 0 24 24"><path d="M4 12 H 7 C 7 9 9 9 9 12 C 9 15 11 15 11 12 C 11 9 13 9 13 12 C 13 15 15 15 15 12 H 20"/></svg>
                     <span class="component-label">Inductor</span>
                 </button>
                <button class="component-btn" data-component="led" title="LED">
                     <svg class="component-icon" viewBox="0 0 24 24"><path d="M4 12 H 8 L 12 7 L 16 12 H 20 M 12 7 V 17 M 9 17 H 15"/><line x1="17" y1="6" x2="19" y2="4" stroke-width="1.5"/><line x1="18" y1="8" x2="20" y2="6" stroke-width="1.5"/></svg>
                    <span class="component-label">LED</span>
                </button>
                <button class="component-btn" data-component="switch" title="Interruptor">
                    <svg class="component-icon" viewBox="0 0 24 24"><path d="M4 12 H 8 M 16 12 H 20 M 8 12 L 16 8"/><circle cx="8" cy="12" r="2.5" fill="white"/><circle cx="16" cy="12" r="2.5" fill="white"/></svg>
                    <span class="component-label">Switch</span>
                </button>
                <button class="component-btn" data-component="battery" title="Batería (Fuente de Voltaje DC)">
                    <svg class="component-icon" viewBox="0 0 24 24"><path d="M4 12 H 8 M 16 12 H 20 M 8 8 V 16 M 12 10 V 14 M 16 8 V 16"/><text x="17" y="9" font-size="5" fill="currentColor">+</text><text x="17" y="17" font-size="5" fill="currentColor">-</text></svg>
                    <span class="component-label">Batería</span>
                </button>
                <button class="component-btn" data-component="ground" title="Tierra">
                    <svg class="component-icon" viewBox="0 0 24 24"><path d="M12 4 V 12 M 8 12 H 16 M 9 15 H 15 M 10.5 18 H 13.5"/></svg>
                    <span class="component-label">Tierra</span>
                </button>
            </div>
            <div class="circuit-canvas" id="circuitCanvas">
                 <svg id="connections-svg"></svg>
                <div id="circuitStage" class="circuit-stage"></div>
                 <div id="tooltip" class="tooltip"></div>
            </div>
        </div>

        <div class="control-panel">
            <div class="panel-section">
                <div class="panel-title">Control de Simulación</div>
                <div class="simulation-controls">
                    <button id="resetSimulationBtn" class="btn btn-danger">Detener Simulación</button>
                    <div class="control-group">
                        <div class="control-label">Tiempo de simulación: <span id="simulationTime">0.00s</span></div>
                    </div>
                    <div id="simulationStatus" style="font-size: 0.9rem; margin-top: 5px;">Estado: Detenido</div>
                </div>
            </div>
            <div class="panel-section component-properties" id="componentPropertiesSection">
                 <div class="panel-title" id="componentPropertiesTitle">
                      <span>Propiedades</span>
                      <button id="deleteComponentBtn" class="btn btn-danger btn-sm" style="display: none;">Eliminar</button>
                  </div>
                 <div id="componentPropertiesContent">
                     <div class="no-component-selected">Selecciona un componente para ver/editar sus propiedades</div>
                 </div>
            </div>
        </div>
    </div>

    <div id="newCircuitModal" class="modal">
         <div class="modal-content" style="max-width: 500px;">
             <div class="modal-header">
                 <div class="modal-title">Nuevo Circuito</div>
                 <button class="modal-close" data-close-modal="newCircuitModal">&times;</button>
             </div>
             <div class="modal-body" style="padding: 1.5rem;">
                 <form id="newCircuitForm" class="new-circuit-form">
                     <div class="form-group">
                         <label class="form-label" for="circuitNameInput">Nombre del Circuito</label>
                         <input type="text" id="circuitNameInput" class="form-input" placeholder="Ej: Circuito RC Básico" required>
                     </div>
                     <div class="form-group">
                         <label class="form-label" for="circuitDescriptionInput">Descripción (opcional)</label>
                         <textarea id="circuitDescriptionInput" class="form-input" rows="3" placeholder="Breve descripción del propósito del circuito..."></textarea>
                     </div>
                     <div class="form-buttons">
                         <button type="button" class="btn btn-danger" data-close-modal="newCircuitModal">Cancelar</button>
                         <button type="submit" class="btn btn-primary">Crear Circuito</button>
                     </div>
                 </form>
             </div>
         </div>
     </div>

     <div id="graphModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                 <div class="modal-title">Análisis del Circuito</div>
                 <button class="modal-close" data-close-modal="graphModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="voltage">Voltaje (Ejemplo)</div>
                    <div class="tab" data-tab="current">Corriente (Ejemplo)</div>
                    <div class="tab" data-tab="power">Potencia (Ejemplo)</div>
                    </div>
                <div id="voltageTab" class="tab-content active">
                    <div class="graph-container" id="voltageGraph">
                        Cargando gráfica de voltaje...
                    </div>
                    <p style="font-size: 0.8em; text-align: center; color: #888;">Nota: Los datos mostrados son solo un ejemplo. La simulación real no está implementada.</p>
                </div>
                <div id="currentTab" class="tab-content">
                    <div class="graph-container" id="currentGraph">
                         Cargando gráfica de corriente...
                    </div>
                     <p style="font-size: 0.8em; text-align: center; color: #888;">Nota: Los datos mostrados son solo un ejemplo.</p>
                </div>
                <div id="powerTab" class="tab-content">
                    <div class="graph-container" id="powerGraph">
                        Cargando gráfica de potencia...
                    </div>
                    <p style="font-size: 0.8em; text-align: center; color: #888;">Nota: Los datos mostrados son solo un ejemplo.</p>
                </div>
                </div>
        </div>
     </div>

     <div class="notification" id="notification">
        <div class="notification-title" id="notificationTitle">Título</div>
        <div class="notification-message" id="notificationMessage">Mensaje</div>
    </div>

    <script>
        // --- CircuitSimulator Object (Lógica Principal) ---
        const CircuitSimulator = {
            // --- STATE (Sin cambios) ---
            circuits: [],
            currentCircuitId: null,
            components: [],
            connections: [],
            selectedComponentId: null,
            selectedConnectionId: null,
            isDragging: false,
            draggedComponentId: null,
            dragOffset: { x: 0, y: 0 },
            isConnecting: false,
            connectionStart: null,
            tempWire: null,
            isSimulating: false,
            simulationTime: 0,
            simulationInterval: null,
            simulationSpeed: 1,
            simulationData: [], // Array para almacenar datos simulados (placeholder)

            // --- DOM Elements (Sin cambios + graph btn) ---
            circuitStage: document.getElementById('circuitStage'),
            connectionsSvg: document.getElementById('connections-svg'),
            circuitsListEl: document.getElementById('circuitsList'),
            componentPropertiesContentEl: document.getElementById('componentPropertiesContent'),
            componentPropertiesTitleEl: document.getElementById('componentPropertiesTitle'),
            deleteComponentBtn: document.getElementById('deleteComponentBtn'),
            tooltipEl: document.getElementById('tooltip'),
            simulationTimeEl: document.getElementById('simulationTime'),
            simulationStatusEl: document.getElementById('simulationStatus'),
            simulateBtn: document.getElementById('simulateBtn'), // Referencia al botón principal
            generateGraphBtn: document.getElementById('generateGraphBtn'),
            // Modals
            newCircuitModal: document.getElementById('newCircuitModal'),
            graphModal: document.getElementById('graphModal'),
            // Notification
            notificationEl: document.getElementById('notification'),
            notificationTitleEl: document.getElementById('notificationTitle'),
            notificationMessageEl: document.getElementById('notificationMessage'),

            // --- CONSTANTS (Sin cambios) ---
            COMPONENT_DEFAULTS: {
                 resistor: { value: 1000, unit: 'Ω' }, capacitor: { value: 1e-6, unit: 'F' }, inductor: { value: 1e-3, unit: 'H' },
                 led: { forwardVoltage: 2.0, unit: 'V', state: 'off' }, switch: { state: 'open' }, battery: { value: 9, unit: 'V' }, ground: {},
            },
            TERMINAL_POSITIONS: {
                 resistor: [{ id: 0, side: 'left' }, { id: 1, side: 'right' }], capacitor: [{ id: 0, side: 'left' }, { id: 1, side: 'right' }], inductor: [{ id: 0, side: 'left' }, { id: 1, side: 'right' }],
                 led: [{ id: 0, side: 'left' }, { id: 1, side: 'right' }], switch: [{ id: 0, side: 'left' }, { id: 1, side: 'right' }], battery: [{ id: 0, side: 'top' }, { id: 1, side: 'bottom' }], ground: [{ id: 0, side: 'top' }],
            },
            COMPONENT_SVG_ICONS: {
                  resistor: `<svg viewBox="0 0 40 20"><path d="M 2 10 H 5 L 7 5 L 11 15 L 15 5 L 19 15 L 23 5 L 27 15 L 29 10 H 38" stroke="black" stroke-width="1.5" fill="none"/></svg>`, capacitor: `<svg viewBox="0 0 40 20"><path d="M 2 10 H 15 M 25 10 H 38 M 15 4 V 16 M 25 4 V 16" stroke="black" stroke-width="1.5" fill="none"/></svg>`, inductor: `<svg viewBox="0 0 40 20"><path d="M 2 10 H 8 C 8 5 12 5 12 10 C 12 15 16 15 16 10 C 16 5 20 5 20 10 C 20 15 24 15 24 10 C 24 5 28 5 28 10 H 38" stroke="black" stroke-width="1.5" fill="none"/></svg>`, led: `<svg viewBox="0 0 40 20"><path d="M 2 10 H 10 L 20 5 L 30 10 H 38 M 20 5 V 15 M 15 15 H 25" stroke="black" stroke-width="1.5" fill="none"/><circle cx="20" cy="10" r="12" stroke="black" stroke-width="1" fill="none" stroke-dasharray="2 2"/></svg>`, switch: `<svg viewBox="0 0 40 20"><path d="M 2 10 H 10 M 30 10 H 38 M 10 10 L 30 5" stroke="black" stroke-width="1.5" fill="none"/><circle cx="10" cy="10" r="3" fill="white" stroke="black" stroke-width="1.5"/><circle cx="30" cy="10" r="3" fill="white" stroke="black" stroke-width="1.5"/></svg>`, battery: `<svg viewBox="0 0 20 30"><path d="M 2 15 H 18 M 5 10 V 20 M 15 5 V 25" stroke="black" stroke-width="1.5" fill="none"/><text x="1" y="7" font-size="6">+</text><text x="1" y="27" font-size="6">-</text></svg>`, ground: `<svg viewBox="0 0 20 30"><path d="M 10 2 V 15 M 4 15 H 16 M 6 19 H 14 M 8 23 H 12" stroke="black" stroke-width="1.5" fill="none"/></svg>`,
            },
            // --- INITIALIZATION ---
            init() {
                 // ... (Igual que antes)
                 this.loadCircuitsFromStorage();
                 this.setupEventListeners();
                 this.renderCircuitsList();

                 if (this.circuits.length > 0) {
                      const lastId = localStorage.getItem('lastCircuitId');
                      const circuitToLoad = this.circuits.find(c => c.id === lastId) || this.circuits[0];
                      this.loadCircuit(circuitToLoad.id);
                 } else {
                     this.createNewCircuit("Circuito Inicial", "Circuito de demostración");
                 }
                 this.showNotification("Simulador iniciado", "Listo para diseñar.", "success");
                 this.checkRecharts(); // Verificar si Recharts está cargado
            },
            checkRecharts() {
                 if (typeof Recharts === 'undefined') {
                      console.error("Recharts no está cargado. Las gráficas no funcionarán.");
                      this.showNotification("Error de Librería", "Recharts no se cargó correctamente.", "error", 5000);
                      this.generateGraphBtn.disabled = true; // Deshabilitar botón si falla
                 } else {
                      console.log("Recharts cargado correctamente.");
                 }
            },
            // --- EVENT LISTENERS ---
            setupEventListeners() {
                // ... (Listeners Navbar, Toolbar, Canvas, Stage, Control Panel, Circuits List, Modals igual que antes) ...
                 document.getElementById('newCircuitBtn').addEventListener('click', () => this.showModal('newCircuitModal'));
                 this.simulateBtn.addEventListener('click', () => this.toggleSimulation()); // Usar la referencia guardada
                 document.getElementById('resetSimulationBtn').addEventListener('click', () => this.stopSimulation());
                 this.generateGraphBtn.addEventListener('click', () => this.showGraphModal()); // Listener para el botón de gráficas

                 // Component Toolbar Listeners
                  document.querySelectorAll('.component-btn').forEach(button => {
                      button.addEventListener('click', (e) => {
                          const componentType = button.dataset.component;
                          const rect = this.circuitStage.getBoundingClientRect();
                          const initialX = this.circuitStage.scrollLeft + rect.width / 2 - 50;
                          const initialY = this.circuitStage.scrollTop + rect.height / 2 - 25;
                          this.addComponent(componentType, initialX, initialY);
                      });
                      button.addEventListener('mouseenter', (e) => this.showTooltip(e.currentTarget.title, e));
                      button.addEventListener('mouseleave', () => this.hideTooltip());
                  });

                 // Stage / Document listeners para Drag, Select, Connect
                 this.circuitStage.addEventListener('mousedown', this.handleStageMouseDown.bind(this));
                 document.addEventListener('mousemove', this.handleDocumentMouseMove.bind(this));
                 document.addEventListener('mouseup', this.handleDocumentMouseUp.bind(this));
                 this.circuitStage.addEventListener('dblclick', this.handleStageDoubleClick.bind(this));
                 this.circuitStage.addEventListener('mouseover', this.handleStageMouseOver.bind(this));
                 this.circuitStage.addEventListener('mouseout', this.handleStageMouseOut.bind(this));
                 // Listener Clic Derecho en Cables (SVG) - Delegado al contenedor SVG
                 this.connectionsSvg.addEventListener('contextmenu', (e) => {
                      if (e.target.classList.contains('connection-wire')) {
                           e.preventDefault();
                           const connId = e.target.dataset.connectionId;
                           if (connId && confirm(`¿Eliminar la conexión ${connId.slice(0, 6)}...?`)) {
                                this.deleteConnection(connId);
                           }
                      }
                 });


                 // Control Panel - Delete Button
                 this.deleteComponentBtn.addEventListener('click', () => this.deleteSelectedComponent());

                 // Circuits List (Delegated)
                  this.circuitsListEl.addEventListener('click', (e) => {
                      const item = e.target.closest('.circuit-item');
                      const deleteBtn = e.target.closest('.delete-circuit-btn');
                      if (deleteBtn && item) {
                          e.stopPropagation();
                          const circuitId = item.dataset.circuitId;
                          if (confirm(`¿Eliminar circuito "${this.circuits.find(c=>c.id===circuitId)?.name}"?`)) {
                              this.deleteCircuit(circuitId);
                          }
                      } else if (item) {
                          this.loadCircuit(item.dataset.circuitId);
                      }
                  });

                  // Modals (New Circuit Form, Close buttons)
                   document.querySelectorAll('[data-close-modal]').forEach(btn => {
                       btn.addEventListener('click', () => this.hideModal(btn.dataset.closeModal));
                   });
                   document.getElementById('newCircuitForm').addEventListener('submit', (e) => {
                       e.preventDefault();
                       const name = document.getElementById('circuitNameInput').value.trim();
                       const description = document.getElementById('circuitDescriptionInput').value.trim();
                       if (name) { this.createNewCircuit(name, description); this.hideModal('newCircuitModal'); e.target.reset(); }
                   });
                   // Graph Modal Tabs
                    this.graphModal.querySelectorAll('.tab').forEach(tab => {
                        tab.addEventListener('click', (e) => this.switchGraphTab(e.target));
                    });


                 // Keyboard shortcuts
                 document.addEventListener('keydown', this.handleKeyDown.bind(this));

            },
            // --- CORE LOGIC: Components (Sin cambios) ---
            addComponent(type, x, y) { /* ... igual ... */
                if (!this.currentCircuitId) { this.showNotification("Error", "No hay un circuito activo.", "error"); return; }
                 const componentId = `comp_${Date.now()}_${Math.random().toString(16).slice(2)}`;
                 const properties = JSON.parse(JSON.stringify(this.COMPONENT_DEFAULTS[type] || {}));
                 const terminalDefs = this.TERMINAL_POSITIONS[type] || [];
                 const newComponent = {
                     id: componentId, type: type, x: Math.max(0, x), y: Math.max(0, y), properties: properties,
                     terminals: terminalDefs.map(tdef => ({ id: `${componentId}_term_${tdef.id}`, parentId: componentId, side: tdef.side, connectedTo: null }))
                 };
                 this.components.push(newComponent); this.renderComponent(newComponent); this.selectComponent(componentId); this.saveCurrentCircuit();
                 this.showNotification("Componente añadido", `${type}`, "success", 1500);
             },
            renderComponent(component) { /* ... igual ... */
                 let componentEl = document.getElementById(component.id);
                 if (!componentEl) {
                     componentEl = document.createElement('div'); componentEl.id = component.id; componentEl.className = 'component';
                     componentEl.dataset.componentId = component.id; componentEl.dataset.type = component.type;
                     this.circuitStage.appendChild(componentEl);
                     componentEl.addEventListener('mousedown', (e) => { if (!e.target.classList.contains('component-terminal')) { this.handleComponentMouseDown(e, component.id); } });
                     if (component.type === 'switch') { componentEl.addEventListener('click', (e) => { if (!this.isDragging && !this.isConnecting) { this.toggleSwitch(component.id); } }); }
                 }
                 componentEl.style.left = `${component.x}px`; componentEl.style.top = `${component.y}px`;
                 const propValue = component.properties.value !== undefined ? `${component.properties.value}${component.properties.unit || ''}` : (component.type === 'ground' ? 'GND' : '');
                 const visualHTML = this.getComponentVisualHTML(component);
                 componentEl.innerHTML = `
                     <div class="component-header"><span class="component-name">${component.type}</span><span class="component-value">${propValue}</span></div>
                     <div class="component-visual">${visualHTML}</div>
                     ${component.terminals.map(term => `<div class="component-terminal ${this.getTerminalPositionClass(term.side)}" data-terminal-id="${term.id}" data-parent-id="${component.id}" title="Terminal ${term.id.slice(-1)}"></div>`).join('')}
                 `;
                 componentEl.querySelectorAll('.component-terminal').forEach(termEl => { termEl.addEventListener('mousedown', (e) => { e.stopPropagation(); this.handleTerminalMouseDown(e, termEl.dataset.parentId, termEl.dataset.terminalId); }); });
                 componentEl.classList.toggle('selected', component.id === this.selectedComponentId);
                 this.updateComponentVisualState(component);
             },
            getComponentVisualHTML(component) { /* ... igual ... */
                  switch (component.type) {
                      case 'led': return `<div class="led-visual ${component.properties.state === 'on' ? 'on' : ''}"></div>`;
                      case 'switch': return `<div class="switch-visual ${component.properties.state === 'closed' ? 'on' : ''}"></div>`;
                      default: return this.COMPONENT_SVG_ICONS[component.type] || `<span style="font-size:0.8em;">${component.type}</span>`;
                  }
             },
            updateComponentVisualState(component) { /* ... igual ... */
                  const componentEl = document.getElementById(component.id); if (!componentEl) return;
                  if (component.type === 'led') { const el = componentEl.querySelector('.led-visual'); if(el) el.classList.toggle('on', component.properties.state === 'on'); }
                  else if (component.type === 'switch') { const el = componentEl.querySelector('.switch-visual'); if(el) el.classList.toggle('on', component.properties.state === 'closed'); }
             },
             toggleSwitch(componentId) { /* ... igual ... */
                  const component = this.getComponentById(componentId); if (!component || component.type !== 'switch') return;
                  component.properties.state = (component.properties.state === 'open') ? 'closed' : 'open';
                  this.updateComponentVisualState(component); this.renderComponentProperties(component); this.saveCurrentCircuit();
                  if (this.isSimulating) { this.runSimulationStep(); }
                  this.showNotification("Switch", `Estado: ${component.properties.state}`, "info", 1000);
              },
            getTerminalPositionClass(side) { /* ... igual ... */
                 switch (side) { case 'left': return 'terminal-left'; case 'right': return 'terminal-right'; case 'top': return 'terminal-top'; case 'bottom': return 'terminal-bottom'; default: return 'terminal-right'; }
             },
             getTerminalAbsolutePosition(componentId, terminalId) { /* ... igual ... */
                  const component = this.getComponentById(componentId); const terminal = component?.terminals.find(t => t.id === terminalId);
                  const componentEl = document.getElementById(componentId); const terminalEl = componentEl?.querySelector(`[data-terminal-id="${terminalId}"]`);
                  if (!component || !terminal || !componentEl || !terminalEl) { console.error("No se pudo encontrar comp/term para pos:", componentId, terminalId); return null; }
                  const termRect = terminalEl.getBoundingClientRect(); const stageRect = this.circuitStage.getBoundingClientRect();
                  const x = termRect.left + termRect.width / 2 - stageRect.left + this.circuitStage.scrollLeft;
                  const y = termRect.top + termRect.height / 2 - stageRect.top + this.circuitStage.scrollTop;
                  return { x, y };
              },
            deleteComponent(componentId) { /* ... igual ... */
                 const connectionsToRemove = this.connections.filter(conn => conn.startCompId === componentId || conn.endCompId === componentId);
                 connectionsToRemove.forEach(conn => this.deleteConnection(conn.id, false));
                 this.components = this.components.filter(c => c.id !== componentId);
                 const componentEl = document.getElementById(componentId); if (componentEl) { componentEl.remove(); }
                 if (this.selectedComponentId === componentId) { this.selectComponent(null); }
                 this.renderAllConnections(); this.saveCurrentCircuit();
                 this.showNotification("Componente eliminado", "", "info", 1500);
             },
             deleteSelectedComponent() { /* ... igual ... */ if (this.selectedComponentId) { this.deleteComponent(this.selectedComponentId); } },
            selectComponent(componentId) { /* ... igual ... */
                 if (this.selectedComponentId === componentId) return;
                 if (this.selectedComponentId) { const oldEl = document.getElementById(this.selectedComponentId); if (oldEl) oldEl.classList.remove('selected'); }
                 this.selectedComponentId = componentId; this.selectedConnectionId = null;
                 if (this.selectedComponentId) {
                     const newEl = document.getElementById(this.selectedComponentId); if (newEl) newEl.classList.add('selected');
                     const comp = this.getComponentById(componentId); this.renderComponentProperties(comp); this.deleteComponentBtn.style.display = 'inline-block';
                 } else {
                     this.renderComponentProperties(null); this.deleteComponentBtn.style.display = 'none';
                 }
             },
            renderComponentProperties(component) { /* ... igual ... */
                  if (!component) { this.componentPropertiesContentEl.innerHTML = `<div class="no-component-selected">Selecciona un componente...</div>`; this.componentPropertiesTitleEl.querySelector('span').textContent = 'Propiedades'; return; }
                  this.componentPropertiesTitleEl.querySelector('span').textContent = `Propiedades (${component.type} - ${component.id.slice(0,8)})`;
                  let html = '<div class="property-group">';
                  const isDisabled = this.isSimulating ? 'disabled' : ''; // Deshabilitar inputs si simula
                  if (component.properties.value !== undefined) { html += `<div class="property-item"><label class="property-label" for="prop_${component.id}_value">Valor:</label><input class="property-input" type="number" step="any" id="prop_${component.id}_value" data-property="value" value="${component.properties.value}" ${isDisabled}>${component.properties.unit ? `<span class="property-unit">${component.properties.unit}</span>` : ''}</div>`; }
                  if (component.type === 'led' && component.properties.forwardVoltage !== undefined) { html += `<div class="property-item"><label class="property-label" for="prop_${component.id}_fv">Voltaje (Fwd):</label><input class="property-input" type="number" step="0.1" id="prop_${component.id}_fv" data-property="forwardVoltage" value="${component.properties.forwardVoltage}" ${isDisabled}><span class="property-unit">V</span></div>`; }
                  if (component.properties.state !== undefined) { html += `<div class="property-item"><label class="property-label">Estado:</label><span style="font-weight:500;">${component.properties.state}</span>${component.type === 'switch' ? '<span style="font-size:0.8em; color:#888;"> (Clic para cambiar)</span>' : ''}</div>`; }
                  html += '</div>'; this.componentPropertiesContentEl.innerHTML = html;
                  this.componentPropertiesContentEl.querySelectorAll('.property-input').forEach(input => { input.addEventListener('change', (e) => { const prop = e.target.dataset.property; let val = e.target.value; if (e.target.type === 'number' || !isNaN(parseFloat(val))) { val = parseFloat(val); if (isNaN(val)) { this.showNotification("Error", "Valor inválido.", "error"); e.target.value = component.properties[prop]; return; } } this.updateComponentProperty(component.id, prop, val); }); });
             },
             updateComponentProperty(componentId, propertyName, newValue) { /* ... igual ... */
                  const component = this.getComponentById(componentId); if (!component || !component.properties.hasOwnProperty(propertyName)) return;
                  component.properties[propertyName] = newValue; this.renderComponent(component); this.renderComponentProperties(component); this.saveCurrentCircuit();
                  if (this.isSimulating) { this.runSimulationStep(); } // Recalcular si simula
              },

            // --- CORE LOGIC: Connections (Sin cambios) ---
            startConnection(componentId, terminalId) { /* ... igual ... */
                 this.isConnecting = true; const startPos = this.getTerminalAbsolutePosition(componentId, terminalId); if (!startPos) { this.isConnecting = false; return; }
                 this.connectionStart = { componentId, terminalId, x: startPos.x, y: startPos.y };
                 this.tempWire = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                 this.tempWire.setAttribute('x1', startPos.x); this.tempWire.setAttribute('y1', startPos.y); this.tempWire.setAttribute('x2', startPos.x); this.tempWire.setAttribute('y2', startPos.y);
                 this.tempWire.setAttribute('class', 'temp-wire'); this.connectionsSvg.appendChild(this.tempWire);
                 document.body.style.cursor = 'crosshair'; this.circuitStage.classList.add('connecting');
             },
            updateTempConnection(mouseX, mouseY) { /* ... igual ... */
                 if (!this.isConnecting || !this.tempWire) return;
                 const stageRect = this.circuitStage.getBoundingClientRect(); const svgX = mouseX - stageRect.left + this.circuitStage.scrollLeft; const svgY = mouseY - stageRect.top + this.circuitStage.scrollTop;
                 this.tempWire.setAttribute('x2', svgX); this.tempWire.setAttribute('y2', svgY);
                 this.circuitStage.querySelectorAll('.component-terminal.highlight').forEach(t => t.classList.remove('highlight'));
                 const terminalEl = document.elementFromPoint(mouseX, mouseY);
                 if (terminalEl && terminalEl.classList.contains('component-terminal') && terminalEl.dataset.terminalId !== this.connectionStart.terminalId) { terminalEl.classList.add('highlight'); }
             },
            endConnection(targetElement, mouseX, mouseY) { /* ... igual ... */
                 if (!this.isConnecting) return;
                 const startCompId = this.connectionStart.componentId; const startTermId = this.connectionStart.terminalId;
                 if (this.tempWire) { this.tempWire.remove(); this.tempWire = null; }
                 document.body.style.cursor = 'default'; this.circuitStage.classList.remove('connecting'); this.circuitStage.querySelectorAll('.component-terminal.highlight').forEach(t => t.classList.remove('highlight'));
                 let endTerminalEl = null;
                 if (targetElement && targetElement.classList.contains('component-terminal')) { endTerminalEl = targetElement; }
                 else { const elUnder = document.elementFromPoint(mouseX, mouseY); if (elUnder && elUnder.classList.contains('component-terminal')) { endTerminalEl = elUnder; } }
                 if (endTerminalEl && endTerminalEl.dataset.terminalId !== startTermId) {
                     const endCompId = endTerminalEl.dataset.parentId; const endTermId = endTerminalEl.dataset.terminalId;
                     const startTerm = this.getComponentById(startCompId)?.terminals.find(t => t.id === startTermId); const endTerm = this.getComponentById(endCompId)?.terminals.find(t => t.id === endTermId);
                     if (startTerm && endTerm) {
                          const connId = `conn_${Date.now()}_${Math.random().toString(16).slice(2)}`;
                          const newConn = { id: connId, startCompId, startTermId, endCompId, endTermId, active: false };
                          this.connections.push(newConn); this.renderConnection(newConn); this.saveCurrentCircuit(); this.showNotification("Conexión creada", "", "success", 1000);
                     } else { this.showNotification("Conexión inválida", "", "warning", 2000); }
                 }
                 this.isConnecting = false; this.connectionStart = null;
             },
             renderConnection(connection) { /* ... igual ... */
                  let lineEl = this.connectionsSvg.querySelector(`[data-connection-id="${connection.id}"]`);
                  if (!lineEl) {
                      lineEl = document.createElementNS('http://www.w3.org/2000/svg', 'line'); lineEl.dataset.connectionId = connection.id; lineEl.classList.add('connection-wire');
                      this.connectionsSvg.appendChild(lineEl);
                      // Eventos de clic derecho ya están delegados al SVG parent
                  }
                  const startPos = this.getTerminalAbsolutePosition(connection.startCompId, connection.startTermId); const endPos = this.getTerminalAbsolutePosition(connection.endCompId, connection.endTermId);
                  if (startPos && endPos) { lineEl.setAttribute('x1', startPos.x); lineEl.setAttribute('y1', startPos.y); lineEl.setAttribute('x2', endPos.x); lineEl.setAttribute('y2', endPos.y); }
                  else { console.warn("Terminal no encontrada para conexión:", connection.id); this.deleteConnection(connection.id); return; }
                  lineEl.classList.toggle('active', !!connection.active);
              },
            renderAllConnections() { /* ... igual ... */
                 const existingLines = new Set(); this.connectionsSvg.querySelectorAll('.connection-wire').forEach(line => existingLines.add(line.dataset.connectionId));
                 const currentConnections = new Set(this.connections.map(c => c.id));
                 this.connections.forEach(conn => this.renderConnection(conn));
                 existingLines.forEach(lineId => { if (!currentConnections.has(lineId)) { const lineEl = this.connectionsSvg.querySelector(`[data-connection-id="${lineId}"]`); if (lineEl) lineEl.remove(); } });
             },
             deleteConnection(connectionId, save = true) { /* ... igual ... */
                  this.connections = this.connections.filter(conn => conn.id !== connectionId);
                  const lineEl = this.connectionsSvg.querySelector(`[data-connection-id="${connectionId}"]`); if (lineEl) { lineEl.remove(); }
                  if (save) { this.saveCurrentCircuit(); this.showNotification("Conexión eliminada", "", "info", 1000); }
                  if (this.isSimulating) { this.runSimulationStep(); }
              },


            // --- CORE LOGIC: Drag & Drop (Sin cambios) ---
            handleComponentMouseDown(event, componentId) { /* ... igual ... */
                 if (event.button !== 0) return; event.preventDefault(); event.stopPropagation(); const component = this.getComponentById(componentId); if (!component) return;
                 this.isDragging = true; this.draggedComponentId = componentId; this.selectComponent(componentId);
                 const componentEl = document.getElementById(componentId); const compRect = componentEl.getBoundingClientRect();
                 this.dragOffset.x = event.clientX - compRect.left; this.dragOffset.y = event.clientY - compRect.top;
                 componentEl.style.zIndex = 10; document.body.style.cursor = 'move';
             },
            handleTerminalMouseDown(event, componentId, terminalId) { /* ... igual ... */ if (event.button !== 0) return; event.preventDefault(); event.stopPropagation(); this.startConnection(componentId, terminalId); },
             handleStageMouseDown(event) { /* ... igual ... */ if (event.button !== 0) return; if (event.target === this.circuitStage || event.target === this.circuitCanvas || event.target === this.connectionsSvg) { this.selectComponent(null); this.selectedConnectionId = null; } },
             handleDocumentMouseMove(event) { /* ... igual ... */
                 if (this.isDragging && this.draggedComponentId) {
                     event.preventDefault(); const component = this.getComponentById(this.draggedComponentId); if (!component) return;
                     const componentEl = document.getElementById(this.draggedComponentId); const stageRect = this.circuitStage.getBoundingClientRect();
                     const newCompX_VP = event.clientX - this.dragOffset.x; const newCompY_VP = event.clientY - this.dragOffset.y;
                     let newX = newCompX_VP - stageRect.left + this.circuitStage.scrollLeft; let newY = newCompY_VP - stageRect.top + this.circuitStage.scrollTop;
                     newX = Math.max(0, newX); newY = Math.max(0, newY); component.x = newX; component.y = newY;
                     componentEl.style.left = `${newX}px`; componentEl.style.top = `${newY}px`; this.updateConnectionsForComponent(this.draggedComponentId);
                 } else if (this.isConnecting) { event.preventDefault(); this.updateTempConnection(event.clientX, event.clientY); }
             },
            handleDocumentMouseUp(event) { /* ... igual ... */
                 if (this.isDragging && this.draggedComponentId) {
                     if (event.button !== 0) return; const compEl = document.getElementById(this.draggedComponentId); if (compEl) { compEl.style.zIndex = 1; }
                     this.isDragging = false; this.draggedComponentId = null; document.body.style.cursor = 'default'; this.saveCurrentCircuit();
                 } else if (this.isConnecting) { if (event.button !== 0) return; this.endConnection(event.target, event.clientX, event.clientY); }
             },
             handleStageDoubleClick(event) { /* ... igual ... */ const compEl = event.target.closest('.component'); if (compEl) { console.log("Double clicked component:", compEl.dataset.componentId); } },
             handleKeyDown(event) { /* ... igual ... */
                 if ((event.key === 'Delete' || event.key === 'Backspace') && this.selectedComponentId) { if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return; event.preventDefault(); this.deleteSelectedComponent(); }
                 else if (event.key === 'Escape') { if (this.isConnecting) { if (this.tempWire) this.tempWire.remove(); this.tempWire = null; document.body.style.cursor = 'default'; this.circuitStage.classList.remove('connecting'); this.isConnecting = false; this.connectionStart = null; console.log("Connection cancelled via Escape."); } else if (this.selectedComponentId || this.selectedConnectionId) { this.selectComponent(null); this.selectedConnectionId = null; } else { this.hideModal('newCircuitModal'); this.hideModal('graphModal'); } }
                 else if (event.ctrlKey && event.key === 's') { event.preventDefault(); this.saveCurrentCircuit(); this.showNotification("Guardado", "Circuito guardado.", "success", 1000); }
             },
              handleStageMouseOver(event) { /* ... igual ... */
                   const target = event.target;
                   if (target.classList.contains('component-terminal')) { const pId = target.dataset.parentId; const tId = target.dataset.terminalId; const comp = this.getComponentById(pId); if (comp) { const term = comp.terminals.find(t => t.id === tId); this.showTooltip(`Terminal ${term?.side} (${comp.type})`, event); } }
                   else if (target.closest('.component')) { const compEl = target.closest('.component'); const compId = compEl.dataset.componentId; const comp = this.getComponentById(compId); if (comp) { this.showTooltip(`${comp.type} (${comp.id.slice(0,6)})`, event); } }
               },
              handleStageMouseOut(event) { /* ... igual ... */ this.hideTooltip(); },
            updateConnectionsForComponent(componentId) { /* ... igual ... */ this.connections.forEach(conn => { if (conn.startCompId === componentId || conn.endCompId === componentId) { this.renderConnection(conn); } }); },

            // --- CORE LOGIC: Simulation ---
            toggleSimulation() {
                 if (this.isSimulating) {
                     this.stopSimulation();
                 } else {
                     this.startSimulation();
                 }
             },
            startSimulation() {
                if (!this.currentCircuitId || this.components.length === 0) { this.showNotification("Simulación", "No hay circuito o componentes.", "warning"); return; }
                if (this.isSimulating) return;
                this.isSimulating = true; this.simulationTime = 0; this.simulationData = []; // Limpiar datos anteriores
                this.simulationStatusEl.textContent = 'Estado: Corriendo'; this.simulationStatusEl.style.color = 'green';
                this.simulateBtn.textContent = 'Simulación Activa'; this.simulateBtn.classList.replace('btn-success', 'btn-danger');
                this.showNotification("Simulación Iniciada", "", "info");
                this.toggleUIEditability(false);
                const intervalTime = 100; // Simular más rápido para gráficas (10 pasos por segundo)
                this.simulationInterval = setInterval(() => {
                    this.simulationTime += intervalTime / 1000;
                    this.simulationTimeEl.textContent = `${this.simulationTime.toFixed(2)}s`;
                    this.runSimulationStep();
                    // Detener después de un tiempo para ejemplo
                    if (this.simulationTime >= 10) { // Simular por 10 segundos
                         this.stopSimulation();
                         this.showNotification("Simulación Completada", "Se simularon 10 segundos.", "success");
                    }
                }, intervalTime);
             },
            stopSimulation() {
                if (!this.isSimulating) return;
                this.isSimulating = false; clearInterval(this.simulationInterval); this.simulationInterval = null;
                this.simulationStatusEl.textContent = 'Estado: Detenido'; this.simulationStatusEl.style.color = 'red';
                // *** CORRECCIÓN AQUÍ: Resetear botón principal ***
                this.simulateBtn.textContent = 'Iniciar Simulación'; this.simulateBtn.classList.replace('btn-danger', 'btn-success');
                this.showNotification("Simulación Detenida", "", "info");
                this.connections.forEach(c => c.active = false); this.components.forEach(comp => { if(comp.type === 'led') comp.properties.state = 'off'; });
                this.renderAllComponents(); this.renderAllConnections();
                this.toggleUIEditability(true);
            },
             toggleUIEditability(editable) { /* ... igual ... */
                  document.querySelectorAll('.component-btn').forEach(btn => btn.disabled = !editable);
                  this.deleteComponentBtn.disabled = !editable || !this.selectedComponentId; // También considerar si hay algo seleccionado
                  this.componentPropertiesContentEl.querySelectorAll('input, select, textarea').forEach(input => input.disabled = !editable);
                  document.getElementById('newCircuitBtn').disabled = !editable;
                  this.circuitsListEl.style.pointerEvents = editable ? 'auto' : 'none';
                  document.getElementById('resetSimulationBtn').disabled = !this.isSimulating && editable; // Solo activo si está corriendo
                  // El botón principal se maneja por su propio estado
             },
             runSimulationStep() { /* ... Placeholder igual que antes, pero ahora guarda datos ... */
                 // Cálculos placeholder...
                 let voltageValue = 0; // Valor por defecto
                 let currentValue = 0;
                 let powerValue = 0;
                 let ledOn = false;

                 // Placeholder: Simular una onda senoidal si hay batería
                 const batteries = this.components.filter(c => c.type === 'battery');
                 if (batteries.length > 0) {
                       const amplitude = batteries[0].properties.value || 9; // Amplitud basada en batería
                       const frequency = 0.5; // Hz (lento para ver)
                       voltageValue = amplitude * Math.sin(2 * Math.PI * frequency * this.simulationTime);
                       currentValue = (voltageValue / 1000) * Math.random(); // Corriente placeholder
                       powerValue = voltageValue * currentValue;
                       ledOn = voltageValue > amplitude * 0.5; // Encender LED si V > 50%
                  }


                 // Actualizar estado visual (LEDs, cables activos - simplificado)
                 this.connections.forEach(conn => conn.active = ledOn); // Activar todos si LED está on (simplificado)
                 this.components.forEach(comp => {
                     if (comp.type === 'led') { comp.properties.state = ledOn ? 'on' : 'off'; }
                 });
                 this.renderAllComponents();
                 this.renderAllConnections();

                 // Guardar datos para gráfica (placeholder)
                 this.simulationData.push({
                     time: parseFloat(this.simulationTime.toFixed(2)),
                     voltage: parseFloat(voltageValue.toFixed(2)),
                     current: parseFloat(currentValue.toFixed(3)),
                     power: parseFloat(powerValue.toFixed(3))
                 });
                 // Limitar tamaño de datos guardados (opcional)
                 if (this.simulationData.length > 500) { this.simulationData.shift(); }

             },
             // --- CORE LOGIC: Circuit Management (Sin cambios) ---
            createNewCircuit(name, description = "") { /* ... igual ... */
                 const newCircuitId = `circ_${Date.now()}`; const newCircuit = { id: newCircuitId, name: name, description: description, components: [], connections: [] };
                 this.circuits.push(newCircuit); this.saveCircuitsToStorage(); this.renderCircuitsList(); this.loadCircuit(newCircuitId); this.showNotification("Circuito Creado", `"${name}"`, "success");
             },
            loadCircuit(circuitId) { /* ... igual ... */
                 if (this.currentCircuitId === circuitId) return; if(this.currentCircuitId) { this.saveCurrentCircuit(); }
                 const circuit = this.circuits.find(c => c.id === circuitId); if (!circuit) { console.error("Circuito no encontrado:", circuitId); this.showNotification("Error al cargar", `ID ${circuitId} no encontrado.`, "error"); return; }
                 this.stopSimulation(); this.currentCircuitId = circuitId; localStorage.setItem('lastCircuitId', circuitId);
                 this.circuitStage.innerHTML = ''; this.connectionsSvg.innerHTML = '';
                 this.components = JSON.parse(JSON.stringify(circuit.components || [])); this.connections = JSON.parse(JSON.stringify(circuit.connections || []));
                 this.selectedComponentId = null; this.selectedConnectionId = null; this.isConnecting = false; this.isDragging = false; document.body.style.cursor = 'default';
                 this.renderAllComponents(); this.renderAllConnections(); this.selectComponent(null); this.renderCircuitsList();
                 console.log(`Circuito cargado: ${circuit.name} (${circuit.id})`); this.showNotification("Circuito Cargado", `"${circuit.name}"`, "info");
             },
              renderAllComponents() { /* ... igual ... */
                   const currentIds = new Set(this.components.map(c => c.id)); this.circuitStage.querySelectorAll('.component').forEach(el => { if (!currentIds.has(el.id)) { el.remove(); } });
                   this.components.forEach(comp => this.renderComponent(comp));
               },
            saveCurrentCircuit() { /* ... igual ... */
                 if (!this.currentCircuitId) return; const circuit = this.circuits.find(c => c.id === this.currentCircuitId);
                 if (circuit) { circuit.components = JSON.parse(JSON.stringify(this.components)); circuit.connections = JSON.parse(JSON.stringify(this.connections)); this.saveCircuitsToStorage(); console.log(`Circuito "${circuit.name}" guardado.`); }
                 else { console.error("Error al guardar, circuito actual no encontrado:", this.currentCircuitId); }
             },
            deleteCircuit(circuitId) { /* ... igual ... */
                 const index = this.circuits.findIndex(c => c.id === circuitId); if (index === -1) return; const deletedName = this.circuits[index].name;
                 this.circuits.splice(index, 1); this.saveCircuitsToStorage(); this.renderCircuitsList();
                 if (this.currentCircuitId === circuitId) {
                     this.currentCircuitId = null; this.circuitStage.innerHTML = ''; this.connectionsSvg.innerHTML = ''; this.components = []; this.connections = []; this.selectComponent(null);
                     if (this.circuits.length > 0) { this.loadCircuit(this.circuits[0].id); } else { this.createNewCircuit("Circuito Nuevo", ""); }
                 } this.showNotification("Circuito Eliminado", `"${deletedName}"`, "info");
             },
            renderCircuitsList() { /* ... igual ... */
                 this.circuitsListEl.innerHTML = ''; if (this.circuits.length === 0) { this.circuitsListEl.innerHTML = '<p style="padding: 1rem; color: #777; font-style: italic;">No hay circuitos.</p>'; return; }
                 this.circuits.forEach(circuit => { const item = document.createElement('div'); item.className = 'circuit-item'; item.dataset.circuitId = circuit.id; item.classList.toggle('active', circuit.id === this.currentCircuitId); item.innerHTML = `<button class="delete-circuit-btn btn btn-danger btn-sm" title="Eliminar ${circuit.name}">&times;</button><div class="circuit-item-name">${circuit.name || 'Sin nombre'}</div><div class="circuit-item-info">${circuit.description || 'Sin desc.'}</div>`; this.circuitsListEl.appendChild(item); });
             },
            loadCircuitsFromStorage() { /* ... igual ... */
                 const savedData = localStorage.getItem('circuits');
                 if (savedData) { try { this.circuits = JSON.parse(savedData); if (!Array.isArray(this.circuits)) { console.warn("Datos guardados corruptos."); this.circuits = []; } } catch (e) { console.error("Error parseando circuitos:", e); this.circuits = []; this.showNotification("Error Carga", "No se pudo leer circuitos.", "error"); } } else { this.circuits = []; }
                 console.log(`Cargados ${this.circuits.length} circuitos.`);
             },
            saveCircuitsToStorage() { /* ... igual ... */ try { localStorage.setItem('circuits', JSON.stringify(this.circuits)); } catch (e) { console.error("Error guardando circuitos:", e); this.showNotification("Error Guardado", "LocalStorage lleno?", "error"); } },

            // --- CORE LOGIC: Graphing (Placeholder) ---
             showGraphModal() {
                  if (typeof Recharts === 'undefined') {
                       this.showNotification("Error", "Librería de gráficas (Recharts) no cargada.", "error");
                       return;
                  }
                  if (this.simulationData.length === 0) {
                      // Generar datos de ejemplo si no hay datos de simulación
                       this.generatePlaceholderGraphData();
                       this.showNotification("Gráfica de Ejemplo", "Mostrando datos de ejemplo. Inicia una simulación para ver datos (placeholder) del circuito.", "info", 4000);
                  } else {
                       this.showNotification("Mostrando Gráficas", "Datos de la última simulación (placeholder).", "info", 2000);
                  }

                  this.renderGraphs(); // Renderizar con los datos actuales (reales o placeholder)
                  this.showModal('graphModal');
                  // Asegurarse que la primera tab esté activa visualmente
                  this.switchGraphTab(this.graphModal.querySelector('.tab[data-tab="voltage"]'));
             },

             generatePlaceholderGraphData() {
                  this.simulationData = [];
                  const duration = 5; // 5 segundos de datos de ejemplo
                  const steps = 100;
                  const amplitude = 5;
                  const frequency = 1; // 1 Hz
                  for (let i = 0; i <= steps; i++) {
                      const t = (i / steps) * duration;
                      const v = amplitude * Math.sin(2 * Math.PI * frequency * t);
                      const c = (v / 100) * (0.8 + Math.random() * 0.4); // Corriente ejemplo
                      const p = v * c;
                      this.simulationData.push({
                          time: parseFloat(t.toFixed(2)),
                          voltage: parseFloat(v.toFixed(2)),
                          current: parseFloat(c.toFixed(3)),
                          power: parseFloat(p.toFixed(3))
                      });
                  }
             },

             renderGraphs() {
                  if (typeof Recharts === 'undefined') return;

                  const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

                  const renderChart = (containerId, dataKey, color, unit) => {
                      const container = document.getElementById(containerId);
                      if (!container) return;
                      container.innerHTML = ''; // Limpiar contenedor

                      const chartElement = React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                          React.createElement(LineChart, { data: this.simulationData, margin: { top: 5, right: 30, left: 0, bottom: 5 } },
                              React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                              React.createElement(XAxis, { dataKey: "time", type: "number", label: { value: "Tiempo (s)", position: "insideBottomRight", offset: -5 }, domain: ['dataMin', 'dataMax'], tickFormatter: (t) => t.toFixed(1) }),
                              React.createElement(YAxis, { label: { value: unit, angle: -90, position: 'insideLeft' }, domain: ['auto', 'auto'], tickFormatter: (v) => v.toFixed(1) }),
                              React.createElement(Tooltip, { formatter: (value) => `${value.toFixed(2)} ${unit}`, labelFormatter: (label) => `t = ${label.toFixed(2)}s` }),
                              // React.createElement(Legend, {}), // Opcional
                              React.createElement(Line, { type: "monotone", dataKey: dataKey, stroke: color, strokeWidth: 2, dot: false, activeDot: { r: 6 } })
                          )
                      );
                      ReactDOM.render(chartElement, container);
                  };

                  renderChart('voltageGraph', 'voltage', '#8884d8', 'V');
                  renderChart('currentGraph', 'current', '#82ca9d', 'A');
                  renderChart('powerGraph', 'power', '#ffc658', 'W');
             },

             switchGraphTab(targetTab) {
                  const activeTab = this.graphModal.querySelector('.tab.active');
                  const activeContent = this.graphModal.querySelector('.tab-content.active');
                  if (activeTab) activeTab.classList.remove('active');
                  if (activeContent) activeContent.classList.remove('active');

                  targetTab.classList.add('active');
                  const tabName = targetTab.dataset.tab;
                  const newContent = document.getElementById(`${tabName}Tab`);
                  if (newContent) {
                      newContent.classList.add('active');
                      // Podrías re-renderizar la gráfica específica aquí si fuera necesario
                      // this.renderSpecificGraph(tabName);
                  }
             },


            // --- UTILITIES / HELPERS (Sin cambios) ---
             getComponentById(id) { return this.components.find(c => c.id === id); },
             getConnectionById(id) { return this.connections.find(c => c.id === id); },
             showModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.classList.add('active'); },
             hideModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('active'); },
             showTooltip(text, event) { /* ... igual ... */
                 if (!text) return; this.tooltipEl.textContent = text; this.tooltipEl.style.display = 'block';
                 const stageRect = this.workspace.getBoundingClientRect(); let x = event.clientX - stageRect.left + 15; let y = event.clientY - stageRect.top + 15;
                 if (event.clientX + this.tooltipEl.offsetWidth + 15 > window.innerWidth) { x = event.clientX - stageRect.left - this.tooltipEl.offsetWidth - 5; }
                 if (event.clientY + this.tooltipEl.offsetHeight + 15 > window.innerHeight) { y = event.clientY - stageRect.top - this.tooltipEl.offsetHeight - 5; }
                 this.tooltipEl.style.left = `${x}px`; this.tooltipEl.style.top = `${y}px`;
              },
             hideTooltip() { this.tooltipEl.style.display = 'none'; },
             _notificationTimeout: null,
             showNotification(title, message, type = 'info', duration = 3000) { /* ... igual ... */
                  if (this._notificationTimeout) { clearTimeout(this._notificationTimeout); }
                  this.notificationTitleEl.textContent = title; this.notificationMessageEl.textContent = message; this.notificationEl.className = 'notification'; this.notificationEl.classList.add(type); this.notificationEl.classList.add('show');
                  this._notificationTimeout = setTimeout(() => { this.notificationEl.classList.remove('show'); this._notificationTimeout = null; }, duration);
             }
        };

         // --- DOM Ready ---
         document.addEventListener('DOMContentLoaded', () => {
             CircuitSimulator.workspace = document.querySelector('.workspace'); // Guardar referencia
             CircuitSimulator.init();
         });
    </script>
</body>
</html>
